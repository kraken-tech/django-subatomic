
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../test/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>db - Django-subatomic docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../static/css/theme.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#django_subatomic.db" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Django-subatomic docs" class="md-header__button md-logo" aria-label="Django-subatomic docs" data-md-component="logo">
      
  <img src="../../../static/img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Django-subatomic docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              db
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="kraken" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/kraken-tech/django-subatomic" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    kraken-tech/django-subatomic
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Django-subatomic docs" class="md-nav__button md-logo" aria-label="Django-subatomic docs" data-md-component="logo">
      
  <img src="../../../static/img/logo.png" alt="logo">

    </a>
    Django-subatomic docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kraken-tech/django-subatomic" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    kraken-tech/django-subatomic
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Subatomic docs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transactions-savepoints-and-atomic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transactions and savepoints
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../why/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Django's Atomic
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Settings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    <code class="doc-symbol doc-symbol-nav doc-symbol-module"></code>django_subatomic
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            <code class="doc-symbol doc-symbol-nav doc-symbol-module"></code>django_subatomic
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    db
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    db
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.transaction" class="md-nav__link">
    <span class="md-ellipsis">
      transaction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.transaction_if_not_already" class="md-nav__link">
    <span class="md-ellipsis">
      transaction_if_not_already
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.savepoint" class="md-nav__link">
    <span class="md-ellipsis">
      savepoint
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.transaction_required" class="md-nav__link">
    <span class="md-ellipsis">
      transaction_required
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.durable" class="md-nav__link">
    <span class="md-ellipsis">
      durable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.run_after_commit" class="md-nav__link">
    <span class="md-ellipsis">
      run_after_commit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.in_transaction" class="md-nav__link">
    <span class="md-ellipsis">
      in_transaction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.dbs_with_open_transactions" class="md-nav__link">
    <span class="md-ellipsis">
      dbs_with_open_transactions
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    test
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.transaction" class="md-nav__link">
    <span class="md-ellipsis">
      transaction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.transaction_if_not_already" class="md-nav__link">
    <span class="md-ellipsis">
      transaction_if_not_already
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.savepoint" class="md-nav__link">
    <span class="md-ellipsis">
      savepoint
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.transaction_required" class="md-nav__link">
    <span class="md-ellipsis">
      transaction_required
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.durable" class="md-nav__link">
    <span class="md-ellipsis">
      durable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.run_after_commit" class="md-nav__link">
    <span class="md-ellipsis">
      run_after_commit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.in_transaction" class="md-nav__link">
    <span class="md-ellipsis">
      in_transaction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django_subatomic.db.dbs_with_open_transactions" class="md-nav__link">
    <span class="md-ellipsis">
      dbs_with_open_transactions
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<div class="doc doc-object doc-module">



<h1 id="django_subatomic.db" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">django_subatomic.db</span>


<a href="#django_subatomic.db" class="headerlink" title="Permanent link">&para;</a></h1>

    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="django_subatomic.db.transaction" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">transaction</span>


<a href="#django_subatomic.db.transaction" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">transaction</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Create a database transaction.</p>
<p>Nested calls are not allowed because SQL does not support nested transactions.
Consider this like Django's <code>atomic(durable=True)</code>, but with added after-commit callback support in tests.</p>
<p>This wraps Django's 'atomic' function.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if we call this from inside another existing transaction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>django_subatomic/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">transaction</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a database transaction.</span>

<span class="sd">    Nested calls are not allowed because SQL does not support nested transactions.</span>
<span class="sd">    Consider this like Django&#39;s `atomic(durable=True)`, but with added after-commit callback support in tests.</span>

<span class="sd">    This wraps Django&#39;s &#39;atomic&#39; function.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: if we call this from inside another existing transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Note that `savepoint=False` is not required here because</span>
    <span class="c1"># the `savepoint` flag is ignored when `durable` is `True`.</span>
    <span class="k">with</span> <span class="p">(</span>
        <span class="n">_execute_on_commit_callbacks_in_tests</span><span class="p">(</span><span class="n">using</span><span class="p">),</span>
        <span class="n">django_transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="k">yield</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="django_subatomic.db.transaction_if_not_already" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">transaction_if_not_already</span>


<a href="#django_subatomic.db.transaction_if_not_already" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">transaction_if_not_already</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Create a transaction if one isn't already open.</p>
<p>Use of this hints at code which lacks control over the state it's called in.</p>
<p>Suggested alternatives:</p>
<ul>
<li>
<p>In functions which should not control transactions, use <code>transaction_required</code>.
  This ensures they are handled by the caller.</p>
</li>
<li>
<p>In functions which can unambiguously control transactions, use <code>transaction</code>.</p>
</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>django_subatomic/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">transaction_if_not_already</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a transaction if one isn&#39;t already open.</span>

<span class="sd">    Use of this hints at code which lacks control over the state it&#39;s called in.</span>

<span class="sd">    Suggested alternatives:</span>

<span class="sd">    - In functions which should not control transactions, use `transaction_required`.</span>
<span class="sd">      This ensures they are handled by the caller.</span>

<span class="sd">    - In functions which can unambiguously control transactions, use `transaction`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If the innermost atomic block is from a test case, we should create a SAVEPOINT here.</span>
    <span class="c1"># This allows for a rollback when an exception propagates out of this block, and so</span>
    <span class="c1"># better simulates a production transaction behaviour in tests.</span>
    <span class="n">savepoint</span> <span class="o">=</span> <span class="n">_innermost_atomic_block_wraps_testcase</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>

    <span class="k">with</span> <span class="p">(</span>
        <span class="n">_execute_on_commit_callbacks_in_tests</span><span class="p">(</span><span class="n">using</span><span class="p">),</span>
        <span class="n">django_transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="n">savepoint</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="k">yield</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="django_subatomic.db.savepoint" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">savepoint</span>


<a href="#django_subatomic.db.savepoint" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">savepoint</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Create a database savepoint.</p>
<p>Must be called inside an active transaction.</p>
<p>Tips:</p>
<ul>
<li>You should only create a savepoint if you may roll back to it before
  continuing with your transaction. If your intention is to ensure that
  your code is committed atomically, consider using <code>transaction_required</code>
  instead.</li>
<li>We believe savepoint rollback should be handled where the savepoint is created.
  That locality is not possible with a decorator, so this function
  deliberately does not work as one.</li>
</ul>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="django_subatomic.db._MissingRequiredTransaction">_MissingRequiredTransaction</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if we are not in a transaction
See Note [_MissingRequiredTransaction in tests]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>django_subatomic/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_utils</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">savepoint</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a database savepoint.</span>

<span class="sd">    Must be called inside an active transaction.</span>

<span class="sd">    Tips:</span>

<span class="sd">    - You should only create a savepoint if you may roll back to it before</span>
<span class="sd">      continuing with your transaction. If your intention is to ensure that</span>
<span class="sd">      your code is committed atomically, consider using `transaction_required`</span>
<span class="sd">      instead.</span>
<span class="sd">    - We believe savepoint rollback should be handled where the savepoint is created.</span>
<span class="sd">      That locality is not possible with a decorator, so this function</span>
<span class="sd">      deliberately does not work as one.</span>

<span class="sd">    Raises:</span>
<span class="sd">        _MissingRequiredTransaction: if we are not in a transaction</span>
<span class="sd">            See Note [_MissingRequiredTransaction in tests]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="p">(</span>
        <span class="n">transaction_required</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">),</span>
        <span class="n">django_transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="k">yield</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="django_subatomic.db.transaction_required" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">transaction_required</span>


<a href="#django_subatomic.db.transaction_required" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">transaction_required</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Make sure that code is always executed in a transaction.</p>
<p>Can be used as a decorator or a context manager.</p>
<p>We ignore test-suite transactions when checking for a transaction
because we don't want to run the risk of allowing code to pass tests
but fail in production.</p>
<p>See Note [_MissingRequiredTransaction in tests]</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="django_subatomic.db._MissingRequiredTransaction">_MissingRequiredTransaction</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if we are not in a transaction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>django_subatomic/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">transaction_required</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure that code is always executed in a transaction.</span>

<span class="sd">    Can be used as a decorator or a context manager.</span>

<span class="sd">    We ignore test-suite transactions when checking for a transaction</span>
<span class="sd">    because we don&#39;t want to run the risk of allowing code to pass tests</span>
<span class="sd">    but fail in production.</span>

<span class="sd">    See Note [_MissingRequiredTransaction in tests]</span>

<span class="sd">    Raises:</span>
<span class="sd">        _MissingRequiredTransaction: if we are not in a transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">using</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">using</span> <span class="o">=</span> <span class="n">django_db</span><span class="o">.</span><span class="n">DEFAULT_DB_ALIAS</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_transaction</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">_MissingRequiredTransaction</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>
    <span class="k">yield</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="django_subatomic.db.durable" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">durable</span>


<a href="#django_subatomic.db.durable" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">durable</span><span class="p">[</span><span class="o">**</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">](</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Enforce durability with this decorator.</p>
<p>"Durability" means that the function's work cannot be rolled back after it completes,
and is not to be confused with "atomicity" (which is about ensuring that the function
either completes all its work or none of it).</p>
<p>We enforce this by ensuring that the function is not called within a transaction,
and that no transaction is left open when the function completes.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="django_subatomic.db._UnexpectedOpenTransaction">_UnexpectedOpenTransaction</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if a transaction is already open when this is called.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="django_subatomic.db._UnexpectedDanglingTransaction">_UnexpectedDanglingTransaction</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if a transaction remains open after the decorated
function exits. Before raising this exeption, we roll back and end the
transaction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>django_subatomic/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">durable</span><span class="p">[</span><span class="o">**</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">](</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforce durability with this decorator.</span>

<span class="sd">    &quot;Durability&quot; means that the function&#39;s work cannot be rolled back after it completes,</span>
<span class="sd">    and is not to be confused with &quot;atomicity&quot; (which is about ensuring that the function</span>
<span class="sd">    either completes all its work or none of it).</span>

<span class="sd">    We enforce this by ensuring that the function is not called within a transaction,</span>
<span class="sd">    and that no transaction is left open when the function completes.</span>

<span class="sd">    Raises:</span>
<span class="sd">        _UnexpectedOpenTransaction: if a transaction is already open when this is called.</span>
<span class="sd">        _UnexpectedDanglingTransaction: if a transaction remains open after the decorated</span>
<span class="sd">            function exits. Before raising this exeption, we roll back and end the</span>
<span class="sd">            transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">open_dbs</span> <span class="o">:=</span> <span class="n">dbs_with_open_transactions</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">_UnexpectedOpenTransaction</span><span class="p">(</span><span class="n">open_dbs</span><span class="o">=</span><span class="n">open_dbs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">open_dbs</span> <span class="o">:=</span> <span class="n">dbs_with_open_transactions</span><span class="p">():</span>
                <span class="c1"># Clean up first, otherwise we may see errors later that will mask this one.</span>
                <span class="c1"># This can only happen if the function manually opens a transaction,</span>
                <span class="c1"># so we need to manually roll it back and close it.</span>
                <span class="k">for</span> <span class="n">db_alias</span> <span class="ow">in</span> <span class="n">open_dbs</span><span class="p">:</span>
                    <span class="n">django_transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db_alias</span><span class="p">)</span>
                    <span class="n">django_transaction</span><span class="o">.</span><span class="n">set_autocommit</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="n">db_alias</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">_UnexpectedDanglingTransaction</span><span class="p">(</span><span class="n">open_dbs</span><span class="o">=</span><span class="n">open_dbs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="django_subatomic.db.run_after_commit" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_after_commit</span>


<a href="#django_subatomic.db.run_after_commit" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_after_commit</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">object</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Register a callback to be called after the current transaction is committed.</p>
<p>If the current transaction is rolled back, the callback will not be called.
By default, an error will be raised if there is no transaction open.
The transaction opened by tests is ignored for this purpose.</p>
<p>Note that Django's <code>on_commit</code> has a <code>robust</code> parameter, which allows a callback to fail silently.
Kraken has a convention to "not allow code to fail silently"
so this behaviour is not available from this function.</p>


            <details class="quote">
              <summary>Source code in <code>django_subatomic/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_after_commit</span><span class="p">(</span>
    <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">object</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a callback to be called after the current transaction is committed.</span>

<span class="sd">    If the current transaction is rolled back, the callback will not be called.</span>
<span class="sd">    By default, an error will be raised if there is no transaction open.</span>
<span class="sd">    The transaction opened by tests is ignored for this purpose.</span>

<span class="sd">    Note that Django&#39;s `on_commit` has a `robust` parameter, which allows a callback to fail silently.</span>
<span class="sd">    Kraken has a convention to &quot;not allow code to fail silently&quot;</span>
<span class="sd">    so this behaviour is not available from this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">using</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">using</span> <span class="o">=</span> <span class="n">django_db</span><span class="o">.</span><span class="n">DEFAULT_DB_ALIAS</span>

    <span class="c1"># See Note [After-commit callbacks require a transaction]</span>
    <span class="n">needs_transaction</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
        <span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;SUBATOMIC_AFTER_COMMIT_NEEDS_TRANSACTION&quot;</span><span class="p">,</span> <span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">only_in_testcase_transaction</span> <span class="o">=</span> <span class="n">_innermost_atomic_block_wraps_testcase</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>

    <span class="c1"># Fail if a transaction is required, but none exists.</span>
    <span class="c1"># Ignore test-suite transactions when checking for a transaction.</span>
    <span class="c1"># See Note [After-commit callbacks require a transaction]</span>
    <span class="k">if</span> <span class="n">needs_transaction</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_transaction</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">_MissingRequiredTransaction</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="c1"># See Note [Running after-commit callbacks in tests]</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;SUBATOMIC_RUN_AFTER_COMMIT_CALLBACKS_IN_TESTS&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">only_in_testcase_transaction</span>
    <span class="p">):</span>
        <span class="n">callback</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">django_transaction</span><span class="o">.</span><span class="n">on_commit</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="django_subatomic.db.in_transaction" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">in_transaction</span>


<a href="#django_subatomic.db.in_transaction" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">in_transaction</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return <code>True</code> if the database connection has a transaction active.</p>
<p>A transaction is active if the connection is no longer in autocommit mode.</p>
<p>So that code doesn't need to handle how testcase transactions work,
testcase transactions are not considered a transaction.</p>


            <details class="quote">
              <summary>Source code in <code>django_subatomic/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">in_transaction</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return `True` if the database connection has a transaction active.</span>

<span class="sd">    A transaction is active if the connection is no longer in autocommit mode.</span>

<span class="sd">    So that code doesn&#39;t need to handle how testcase transactions work,</span>
<span class="sd">    testcase transactions are not considered a transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">using</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">using</span> <span class="o">=</span> <span class="n">django_db</span><span class="o">.</span><span class="n">DEFAULT_DB_ALIAS</span>

    <span class="n">connection</span> <span class="o">=</span> <span class="n">django_db</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">using</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If there is no database connection, we can&#39;t be in a transaction.</span>
        <span class="c1"># We need to check this before checking for an open transaction,</span>
        <span class="c1"># because `get_autocommit()` would open a database connection</span>
        <span class="c1"># which we might not use and would consume resources unnecessarily.</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">in_transaction</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">django_transaction</span><span class="o">.</span><span class="n">get_autocommit</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_transaction</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">only_in_testcase_transaction</span> <span class="o">=</span> <span class="n">_innermost_atomic_block_wraps_testcase</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>

    <span class="c1"># To make this as clear as possible I&#39;ve spelled out the boolean logic here,</span>
    <span class="c1"># and have told ruff to ignore that this could have been simply:</span>
    <span class="c1">#</span>
    <span class="c1">#     return not only_in_testcase_transaction</span>
    <span class="k">if</span> <span class="n">only_in_testcase_transaction</span><span class="p">:</span>  <span class="c1"># noqa: SIM103</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="django_subatomic.db.dbs_with_open_transactions" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">dbs_with_open_transactions</span>


<a href="#django_subatomic.db.dbs_with_open_transactions" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">dbs_with_open_transactions</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get the names of databases with open transactions.</p>


            <details class="quote">
              <summary>Source code in <code>django_subatomic/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbs_with_open_transactions</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the names of databases with open transactions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbs_with_open_transaction</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c1"># Note: django_db.connections is a special class which implements __iter__,</span>
    <span class="c1"># and should not be confused with a list or dict.</span>
    <span class="k">for</span> <span class="n">db_alias</span> <span class="ow">in</span> <span class="n">django_db</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">in_transaction</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db_alias</span><span class="p">):</span>
            <span class="n">dbs_with_open_transaction</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">db_alias</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">dbs_with_open_transaction</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.indexes"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"alias": true, "default": ["latest"], "provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>